name: Databricks DAB â€” Feature Branch Deploy

on:
  workflow_dispatch:

  push:
    branches:
      - "feat/*"
      - "feature/*"
      - "wcl/*"

permissions:
  id-token: write
  contents: read

jobs:
  deploy-feature:
    name: Deploy Bundle to Databricks (Feature Branch)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # Configure Databricks authentication (OIDC or token-based)
      - name: Configure Databricks CLI auth
        uses: databricks/setup-cli@main
        with:
          host: ${{ secrets.DATABRICKS_HOST }}
          # If using PAT:
          token: ${{ secrets.DATABRICKS_TOKEN }}
          # If using OIDC, use these instead:
          # client-id: ${{ secrets.DATABRICKS_CLIENT_ID }}
          # workspace-resource-id: ${{ secrets.DATABRICKS_WORKSPACE_RESOURCE_ID }}

      # Validate bundle using Databricks official container
      - name: Validate bundle (dev target)
        uses: docker://ghcr.io/databricks/bundle-runner:latest
        with:
          args: bundle validate --environment dev --workspace

      # Deploy bundle
      - name: Deploy bundle to Databricks (dev target)
        uses: docker://ghcr.io/databricks/bundle-runner:latest
        with:
          args: bundle deploy --environment dev --workspace

      # Run ingestion job
      - name: Run ingestion job
        uses: docker://ghcr.io/databricks/bundle-runner:latest
        with:
          args: bundle run warcraftlogs_ingest_job --environment dev --workspace
