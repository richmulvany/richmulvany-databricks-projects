name: Deploy HR Chatbot

on:
  push:
    branches:
      - main
    paths:
      - 'contracts/**'
      - 'jobs/**'
      - 'notebooks/**'
      - 'resources/databricks.yml'
  workflow_dispatch:

env:
  DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
  DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}

jobs:
  deploy-bundle:
    name: "üì¶ Deploy Asset Bundle"
    runs-on: ubuntu-latest

    steps:
      - name: "üì• Checkout repo"
        uses: actions/checkout@v3

      - name: "üõ†Ô∏è Install Databricks CLI"
        uses: databricks/setup-cli@main

      - name: "‚öôÔ∏è Configure Databricks CLI"
        run: |
          mkdir -p ~/.databricks
          cat <<EOF > ~/.databrickscfg
          [DEFAULT]
          host = $DATABRICKS_HOST
          token = $DATABRICKS_TOKEN
          EOF

      - name: "üßπ Copy deployable files"
        run: |
          mkdir deploy-dir
          cp hr-chatbot/resources/databricks.yml deploy-dir/
          cp -r hr-chatbot/contracts \
                hr-chatbot/jobs \
                deploy-dir/

      - name: "‚úÖ Validate DAB Bundle"
        working-directory: deploy-dir
        run: databricks bundle validate

      - name: "üöÄ Deploy Asset Bundle"
        working-directory: deploy-dir
        run: databricks bundle deploy --force-lock
        
