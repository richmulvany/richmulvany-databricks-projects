name: Deploy and Run WarcraftLogs Job

on:
  push:
    paths:
      - 'warcraftlogs-raid-analysis/**'
      - '.github/workflows/deploy-warcraftlogs.yml'

jobs:
  deploy-and-run:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout repo
        uses: actions/checkout@v3

      - name: üõ†Ô∏è Install Databricks CLI
        uses: databricks/setup-cli@main

      - name: üíâ Inject job YAML into databricks.yml
        working-directory: warcraftlogs-raid-analysis
        run: |
          JOB_DEFINITION="$(jobs/bronze-ingestion-extraction-job.yaml)"
          export JOB_DEFINITION
          envsubst < databricks.yml.template > databricks.yml

      - name: üêõ Output final databricks.yml for debugging
        working-directory: warcraftlogs-raid-analysis
        run: cat databricks.yml

      - name: üöÄ Deploy and Run Asset Bundle
        working-directory: warcraftlogs-raid-analysis
        run: |
          databricks bundle deploy
          databricks bundle run bronze-ingestion-extraction-job --refresh-all
        env:
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
          DATABRICKS_BUNDLE_ENV: default
          DATABRICKS_CLUSTER_ID: ${{ secrets.DATABRICKS_CLUSTER_ID }}
          DATABRICKS_HOST_ADDRESS: ${{ vars.DATABRICKS_HOST_ADDRESS }}
