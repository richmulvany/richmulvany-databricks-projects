name: Deploy and Run WarcraftLogs Job

on:
  workflow_dispatch:
    inputs:
      report_id:
        description: "Optional: report_id to pass to job"
        required: false
        default: "rVnDB4fcb9qZAPLv"

jobs:
  deploy-and-run:
    runs-on: ubuntu-latest
    environment: prod

    env:
      DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
      DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}

    steps:
      - name: üì• Checkout repo
        uses: actions/checkout@v3

      - name: üõ†Ô∏è Install Databricks CLI
        uses: databricks/setup-cli@main
        with:
          host: ${{ secrets.DATABRICKS_HOST }}
          token: ${{ secrets.DATABRICKS_TOKEN }}

      - name: üßπ Copy deployable files
        run: |
          mkdir deploy-dir
          ‚Ä¶ 
      - name: ‚úÖ Validate DAB Bundle
        working-directory: deploy-dir
        run: databricks bundle validate

      - name: üöÄ Deploy and Run Asset Bundle
        working-directory: deploy-dir
        run: |
          databricks bundle deploy --force-lock
          databricks bundle run bronze-ingestion-extraction-job \
            --refresh-all \
            -p report_id=${{ github.event.inputs.report_id }}
