name: Deploy and Run WarcraftLogs Job

on:
  workflow_dispatch:
    inputs:
      report_id:
        description: "Optional: report_id to pass to job"
        required: false
        default: "rVnDB4fcb9qZAPLv"

jobs:
  deploy-and-run:
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout repo
        uses: actions/checkout@v3

      - name: 🛠️ Install Databricks CLI
        uses: databricks/setup-cli@main

      - name: 🔐 Configure Databricks auth
        run: |
          mkdir -p ~/.databricks
          echo "[DEFAULT]" > ~/.databricks/.databrickscfg
          echo "host = https://dbc-4b3f5758-e807.cloud.databricks.com" >> ~/.databricks/.databrickscfg
          echo "token = ${{ secrets.DATABRICKS_TOKEN }}" >> ~/.databricks/.databrickscfg
        env:
          DATABRICKS_HOST: https://dbc-4b3f5758-e807.cloud.databricks.com
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}

      - name: 🧹 Copy deployable files
        run: |
          mkdir deploy-dir
          cp warcraftlogs-raid-analysis/databricks.yml deploy-dir/
          cp -r warcraftlogs-raid-analysis/jobs deploy-dir/
          cp -r warcraftlogs-raid-analysis/notebooks deploy-dir/
          cp -r warcraftlogs-raid-analysis/utils deploy-dir/
          cp -r warcraftlogs-raid-analysis/dashboards deploy-dir/

      - name: ✅ Validate DAB Bundle
        working-directory: deploy-dir
        run: databricks bundle validate
        env:
          DATABRICKS_HOST: https://dbc-4b3f5758-e807.cloud.databricks.com
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}

      - name: 🧪 Echo CLI invocation
        run: |
          echo "Running with report_id=${{ github.event.inputs.report_id }}"
          echo "Command: databricks bundle run bronze-ingestion-extraction-job --refresh-all -p report_id=${{ github.event.inputs.report_id }}"

      - name: 🚀 Deploy and Run Asset Bundle
        working-directory: deploy-dir
        run: |
          databricks bundle deploy --force-lock
          databricks bundle run bronze-ingestion-extraction-job --refresh-all -p report_id=${{ github.event.inputs.report_id }}
        env:
          DATABRICKS_HOST: https://dbc-4b3f5758-e807.cloud.databricks.com
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
